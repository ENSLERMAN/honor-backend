# Инструкция по миграции 
### Перенос Backend'a
Для переноса бэкенда на новый сервер необходимо

1. По пути в проекте `src/main/java/resources` 
открыть файл  `application.properties`
2. В этом файле имеется несколько основных настроек которые отвечают за работу и их нужно поменять при миграции
    1. `server.port=value`, вместо `value` следует указать адрес локального порта на котором будет запущен бэкенд
    2. `spring.mail.host=value`, вместо `value` следует указать адрес почтового сервера, который будет использоваться для рассылки сообщений по электронной почте
    3. `spring.mail.username=value1` и `spring.mail.password=value2`, вместо `value1` следует указать адрес электронной почты, вместо `value2` пароль
    4. `base.server.path=value`, вместо `value` следует указать путь до папки на сервере где будет распологаться `static` директория
    5. `backend.url=value`, вместо `value` следует указать URL адрес по которому находиться бекенд
3. В этой же папке открыть файл `hibernate.cfg.xml`, в этом файле также есть несколько настроек необходимых для миграции
    1. `<property name="hibernate.connection.url">jdbc:mysql://ADDRESS/SCHEMA?useLegacyDatetimeCode=false&amp;serverTimezone=UTC&amp;useUnicode=yes&amp;characterEncoding=UTF-8</property>`,
    вместо `ADDRESS/SCHEMA` необходимо подставить адресс базы данных и схему
    2. `<property name="hibernate.connection.password">PASSWORD</property>`, вместо `PASSWORD` необходимо подставить пароль от базы данных
    3. `<property name="hibernate.connection.username">USERNAME</property>`, вместо `USERNAME` необходимо подставить имя пользователя базы данных
4. После внесенных изменений в проект, необходимо его собрать в исполняем файл для запуска на сервере, для этого нужно проделать следующие действия:
    1. Установить java 8 версии или выше если она у вас не установлена
    2. перейти в корень проекта и если вы пользователь UNIX систем воспользоваться командой в терминале `sudo ./mvnw clean package`, если вы пользователь Windows то использловать команду `./mvnw.cmd clean package`, в случае ошибок проверьте что у вас компьютер имеет доступ в интернет и пользователь имеет права на исполнение файла
    3. После выполнения 2 и 3 пункта в корне проекта появится папка `target` внутри этой папки будет находиться исполняемый jar файл
5. Теперь на новом сервере необходимо настроить nginx и указать для домена отвечающего за бекенд `static` директорию и затем внутри данной директории создать следующую иерархию папок:
    * awards
    * events
    * gallery
    * memo
    * news
    * rally
    * temp
    
    каждая из этих папок будет иметь внутри себя папку с соответсвующим контентом. Если при переносе на новый сервер необходимо сохранить контент, то нужно взять эти папки со всем содержимым и перенести все на новый сервер. Админпанель имеет функционал загрузки всех файлов из `static` директории рекурсивно.
6. Далее необходимо сделать дамп базы данных , можно сделать это вручную, либо воспользоваться админ панелью. После создания дампа нужно исполнить полученный sql на новом сервере баз данных
7. В конечном итоге остается запустить бекенд на новом сервере, для этого необходимо создать соответсвующий сервис в операционной системе для запуска бекенда в фоне. Если вы используете Ubuntu 16.04 и выше то можно использовать [данное руководство](http://www.jcgonzalez.com/ubuntu-16-java-service-wrapper-example)
8. Для проверки того что бекенд запущен перейди по адресу бекенда по пути /public/test, будет отображено сообщение отличное от сообщения 502 которое предоставляет nginx

### Перенос фронтенда и админ панели

Админ панель и фронтенд это два ангулар проекта, поэтому инструкция по переносу практически не отличается, все отличия будут описаны подробно, в остальном все будет применимо и для того и для другого

1. Необходимо в файле `http.service.ts` в строке `private url:string="value";` изменить `value` на адрес бекенда, этот файл находится по пути: `src/app/services/http.service.ts` этот путь одинаков как для фронтенда так и для админ панели
2. (Необязательный шаг) **При изменении url адреса сайта**, необходимо получить новый API key для сервиса Яндекс.Метрика, после получения API key , его необходимо подставить в поле

        yandexHeaders: HttpHeaders = new HttpHeaders({
             'Authorization': 'OAuth ' + 'API_KEY'
         }); 
    , где вместо `API_KEY` написать новый полученный API key
3. Далее необходимо скомпилировать оба проекта
    1. Убедитесь что у вас на компьютере установлен nodejs, npm и angular cli, если они не установлены, установите их
    2. Откройте терминал по пути корневой директории проекта
    3. Выполните команду `npm i`
    4. Выполните команду `ng build --prod`
    5. Далее вы обнаружите в корне проекта директорию `dist` внутри которой будет находиться папка со скомпилированным проектом
    **(в случае ошибок выполнения какой-либо команды, убедитесь, что ваш компьютер подключен к интернету и у вас установленны необходимые программы и п.1)**
4. После этого настройте для вашего веб-сервера поддомены для админ панели и фронтенда
5. Перенесите скомпилированные проекты в необходимые папки на сервере
6. Проверьте работоспособность зайдя на сайты через браузер 